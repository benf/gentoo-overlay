From aa67b77334b801e846553c3d348e7930af22eac7 Mon Sep 17 00:00:00 2001
From: ben <benjaminfranzke@googlemail.com>
Date: Wed, 4 Aug 2010 13:04:07 +0200
Subject: [PATCH 1/2] egl_dri2: get driver_name from udev if it isnt in driver_map

---
 src/egl/drivers/dri2/egl_dri2.c |   11 +++++++++++
 1 files changed, 11 insertions(+), 0 deletions(-)

diff --git a/src/egl/drivers/dri2/egl_dri2.c b/src/egl/drivers/dri2/egl_dri2.c
index a3dc487..21e0863 100644
--- a/src/egl/drivers/dri2/egl_dri2.c
+++ b/src/egl/drivers/dri2/egl_dri2.c
@@ -962,6 +962,17 @@ dri2_get_driver_for_fd(int fd)
 	 }
    }
 
+   const char *udev_driver_name = udev_device_get_driver(parent);
+   if (udev_driver_name != NULL) {
+#define IS_R3XX(pciid) ((pciid > 0x3150) && (pciid < 0x796f))
+      driver = strdup(strcmp(udev_driver_name, "radeon") == 0 ?
+		   (IS_R3XX(chip_id) ? "r300": "r600") :
+		   udev_driver_name);
+      _eglLog(_EGL_DEBUG, "pci id for %d: %04x:%04x, driver %s (udev_device_get_driver)",
+              fd, vendor_id, chip_id, driver);
+      goto out;
+   }
+
  out:
    udev_device_unref(device);
    udev_unref(udev);
-- 
1.6.4.4

